define(function(require){function t(e,t,o){console.log(e);for(var n=0;n<e.squares.length;n++){var s=e.squares[n];if(!s.textView){var i=new I.Rect({x:s.offsetX,y:s.offsetY,width:t.SQUARE_SIZE,height:t.SQUARE_SIZE,stroke:t.SELECTED_COLOUR,strokeWidth:t.LINE_WIDTH_HOVER,fill:0==n&&o?t.TEXT_ENTRY_FILL:t.FILL_COLOUR_HOVER}),a=new I.Text({x:s.offsetX,y:s.offsetY,fontSize:30,fill:t.SELECTED_COLOUR,fontFamily:"Bree Serif",width:i.getWidth(),align:"center",sq:i,square:s,line:e,Text:s.letter?s.letter:""});o||(a.on("mousedown",function(){g&&r(g),this.getAttr("sq").fill(t.TEXT_ENTRY_FILL),L.draw(),g=this.getAttr("line"),_=!0,E=this.getAttr("square")}),a.on("unfocus",function(){this.getAttr("sq").fill("white"),L.draw()})),s.crosswordLevelDrawing=i,s.textView=a,L.add(i),L.add(a),L.draw(),_=o,g=e}}}function r(e){for(var t=0;t<e.squares.length;t++)e.squares[t].crosswordLevelDrawing.fill("White")}function o(e,t){for(var r=0;r<e.squares.length;r++)for(var o=0;o<e.squares[r].length;o++)n(e.squares[r][o],t)}function n(e,t){e.drawing.stroke(t.LINE_COLOUR),e.drawing.strokeWidth(t.LINE_WIDTH),e.drawing.fill(t.FILL_COLOUR)}function s(e,t,r){var n=new I.Rect({x:e.offsetX,y:e.offsetY,width:t.SQUARE_SIZE,height:t.SQUARE_SIZE,stroke:t.LINE_COLOUR,strokeWidth:t.LINE_WIDTH,fill:t.FILL_COLOUR});e.drawing=n,n.on("mouseover",function(){if(!_){if(h)if(o(r,t),e.coordX==mousedownSquare.coordX){if(e.coordY>=mousedownSquare.coordY)for(var n=mousedownSquare.coordY;n<=e.coordY;n++)r.squares[e.coordX][n].drawing.stroke(t.LINE_COLOUR_HOVER),r.squares[e.coordX][n].drawing.strokeWidth(t.LINE_WIDTH_HOVER),r.squares[e.coordX][n].drawing.fill(t.FILL_COLOUR_HOVER),O.push(r.squares[e.coordX][n])}else if(e.coordY==mousedownSquare.coordY&&e.coordX>=mousedownSquare.coordX)for(var n=mousedownSquare.coordX;n<=e.coordX;n++)r.squares[n][e.coordY].drawing.stroke(t.LINE_COLOUR_HOVER),r.squares[n][e.coordY].drawing.strokeWidth(t.LINE_WIDTH_HOVER),r.squares[n][e.coordY].drawing.fill(t.FILL_COLOUR_HOVER),O.push(r.squares[n][e.coordY]);this.stroke(t.LINE_COLOUR_HOVER),this.strokeWidth(t.LINE_WIDTH_HOVER),this.fill(t.FILL_COLOUR_HOVER),w.draw()}}),n.on("mouseout",function(){_||(this.stroke(t.LINE_COLOUR),this.strokeWidth(t.LINE_WIDTH),this.fill(t.FILL_COLOUR),w.draw())}),n.on("mousedown",function(){_||(h=!0,mousedownSquare=e,this.stroke(t.LINE_COLOUR_HOVER),this.strokeWidth(t.LINE_WIDTH_HOVER),this.fill(t.FILL_COLOUR_HOVER),w.draw())}),n.on("mouseup",function(){_||(h=!1,mouseupsquare=e,mousedownSquare!==mouseupsquare&&controller.addLine(mousedownSquare,mouseupsquare))}),w.add(n)}function i(e){for(var t=0;t<e.squares.length;t++)if(!e.squares[t].textView.getText())return e.squares[t]}function a(e){return new I.Rect({x:0,y:0,width:f.getWidth(),height:f.getHeight(),fill:"black",opacity:e})}function u(e){for(var t=0;t<e.lines.length;t++)if(e.lines[t].num){var r=new I.Text({Text:e.lines[t].num,x:e.lines[t].squares[0].offsetX+1,y:e.lines[t].squares[0].offsetY+1,fontSize:15,fill:e.viewProperties.LINE_COLOUR_HOVER,fontFamily:"Arial",align:"left"});console.log(r),L.add(r),L.draw()}}function d(e){for(var t=0;t<e.length;t++){for(var r="",o=0;o<e[t].squares.length;o++)r+=e[t].squares[o].textView.text();document.getElementById(e[t].horizontal?"clue-entry-across":"clue-entry-down").innerHTML+="<div>"+e[t].num+". "+r+" <input  id='clue-entry-"+e[t].num+(e[t].horizontal?"h":"d")+"' type='text' placeholder='enter clue here'></input></div>"}document.getElementById("clue-entry").classList.add("modal")}function l(e){for(var t=0;t<e.length;t++)e[t].horizontal&&e[t].num?(document.getElementById("across-clues-beneath").getElementsByTagName("ol")[0].innerHTML+="<li>"+e[t].num+". "+e[t].clue+" ("+e[t].squares.length+")</li>",document.getElementById("across-clues").getElementsByTagName("ol")[0].innerHTML+="<li>"+e[t].num+". "+e[t].clue+" ("+e[t].squares.length+")</li>"):e[t].num&&(document.getElementById("down-clues").getElementsByTagName("ol")[0].innerHTML+="<li>"+e[t].num+". "+e[t].clue+" ("+e[t].squares.length+")</li>");document.getElementById("across-clues-beneath").classList.remove("clue"),document.getElementById("across-clues").classList.remove("clue"),document.getElementById("down-clues").classList.remove("clue")}function c(){document.getElementById("clue-entry").classList.remove("modal")}var f,w,L,h,g,m,E,I=require("../kinetic"),O=[],_=!1;return window.addEventListener("keypress",function(e){if(_){var t=E||i(g);e=e||window.event;var r="number"==typeof e.which?e.which:e.keyCode;r&&(t.textView.text(String.fromCharCode(r)),t.letter=String.fromCharCode(r),t.crosswordLevelDrawing.fill("white"),E?(t=g.squares[g.squares.indexOf(t)+1],E=t):t=i(g),t?(t.crosswordLevelDrawing.fill(m.TEXT_ENTRY_FILL),L.draw()):(L.draw(),_=!1))}}),{makeStage:function(e){m=e,f=new I.Stage({container:m.CONTAINER,width:m.WIDTH,height:m.HEIGHT})},setController:function(e){controller=e},draw:function(e){w=new I.Layer,L=new I.Layer;for(var t=0;t<e.squares.length;t++)for(var r=0;r<e.squares[t].length;r++)s(e.squares[t][r],e.viewProperties,e);f.add(w),f.add(L)},drawCrossword:function(e){for(var r=0;r<e.lines.length;r++)t(e.lines[r],e.viewProperties,!0)},drawEmptyCrossword:function(e){L||(L=new I.Layer),f.add(L),L.add(a(1));for(var r=0;r<e.lines.length;r++)t(e.lines[r],e.viewProperties,!1);u(e),l(e.lines),L.draw()},getRidOfGrid:function(){var e=a(0);w.add(e);var t=new Kinetic.Tween({node:e,duration:1,opacity:1});t.play(),w.draw()},addNumbers:function(e){u(e)},addClues:function(e){l(e)},getClues:function(e){d(e)},showUrl:function(e){document.getElementById("url").innerHTML='<a href="'+e+'">link to this cross word</a>',document.getElementById("url-text").value=e,document.getElementById("url-text").style.display="block"},hideCluesGetter:function(){c()}}});