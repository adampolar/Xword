define(function(require){function r(){return L}function o(){for(var e=[],r=L.WIDTH/(L.SQUARE_SIZE+2*L.BUMPER_SIZE),o=L.HEIGHT/(L.SQUARE_SIZE+2*L.BUMPER_SIZE),s=L.WIDTH-(r-r%1)*(L.SQUARE_SIZE+2*L.BUMPER_SIZE),n=L.HEIGHT-(o-o%1)*(L.SQUARE_SIZE+2*L.BUMPER_SIZE),t=0;r>t;t++){e[t]=[];for(var u=0;o>u;u++)e[t][u]={offsetX:s/2+(L.SQUARE_SIZE+L.BUMPER_SIZE)*t+L.BUMPER_SIZE,offsetY:n/2+(L.SQUARE_SIZE+L.BUMPER_SIZE)*u+L.BUMPER_SIZE,coordX:t,coordY:u}}return e}function s(e,r){if(e.coordX===r.coordX)return w.squares[e.coordX].slice(e.coordY,r.coordY+1);if(e.coordY===r.coordY){for(var o=[],s=e.coordX;s<=r.coordX;s++)o[s-e.coordX]=w.squares[s][e.coordY];return o}}function n(e,r,o){"undefined"==typeof w.lines&&(w.lines=[]);var n=s(e,r);if("undefined"==typeof n)return null;for(var t=0;t<n.length;t++)n[t].addedToCrossword=!0;w.lines[w.lines.length]={squares:n,clue:o,horizontal:e.coordX===r.coordX}}function t(e){for(var r=0;r<e.length;r++){var o=e[r];o.horizontal=o.squares[0].coordY===o.squares[1].coordY;for(var s=!1,n=w.squares[o.horizontal?o.squares[0].coordX-1:o.squares[0].coordX][o.horizontal?o.squares[0].coordY:o.squares[0].coordY-1];!s&&n&&n.addedToCrossword;)o.squares.unshift(n),n=w.squares[o.horizontal?o.squares[0].coordX-1:o.squares[0].coordX][o.horizontal?o.squares[0].coordY:o.squares[0].coordY-1];s=!1;for(var t=w.squares[o.horizontal?o.squares[0].coordX+1:o.squares[0].coordX][o.horizontal?o.squares[0].coordY:o.squares[0].coordY+1];!s&&n&&n.addedToCrossword;)o.squares.push(t),t=w.squares[o.horizontal?o.squares[0].coordX+1:o.squares[0].coordX][o.horizontal?o.squares[0].coordY:o.squares[0].coordY+1]}i()}function u(e,r){return e.squares[0].coordY<r.squares[0].coordY?-1:e.squares[0].coordY>r.squares[0].coordY?1:e.squares[0].coordX<r.squares[0].coordX?-1:e.squares[0].coordX>r.squares[0].coordX?1:void 0}function a(e,r){for(var o=0;o<w.lines.length;o++)if(w.lines[o].squares[0]===e&&w.lines[o].squares[1]===r)return;for(var s=e,t=e.coordX===r.coordX;w.squares[t?s.coordX+1:s.coordX][t?s.coordY:s.coordY+1].addedToCrossword;)s=w.squares[t?s.coordX+1:s.coordX][t?s.coordY:s.coordY+1];return n(e,s,"a"),!1}function i(){for(var e=c(),r=f(),o=q(),s=E(),n=e.coordX;n<=r.coordX;n++)for(var t=o.coordY;t<=s.coordY;t++)w.squares[n][t].addedToCrossword&&(w.squares[n-1][t]&&w.squares[n-1][t].addedToCrossword||!w.squares[n+1][t].addedToCrossword||a(w.squares[n][t],w.squares[n+1][t]),w.squares[n][t-1]&&w.squares[n][t-1].addedToCrossword||!w.squares[n][t+1].addedToCrossword||a(w.squares[n][t],w.squares[n][t+1]))}function d(){t(w.lines),w.lines.sort(u);for(var e=1,r=0;r<w.lines.length;r++)w.lines[r].squares[0].num?w.lines[r].num=w.lines[r].squares[0].num:(w.lines[r].num=e,w.lines[r].squares[0].num=e,e++)}function l(e,r,o,s){for(var n={clue:e.clue,horizontal:e.horizontal,num:e.num,squares:[]},t=0;t<e.squares.length;t++)n.squares[t]={offsetX:e.squares[t].offsetX-r.offsetX,offsetY:e.squares[t].offsetY-o.offsetY,coordX:e.squares[t].coordX-r.coordX,coordY:e.squares[t].coordY-o.coordY,num:e.squares[t].num,letter:s?e.squares[t].letter:""};return n}function c(){for(var e=w.lines[0].squares[0],r=1;r<w.lines.length;r++)w.lines[r].squares[0].coordX<e.coordX&&(e=w.lines[r].squares[0]);return e}function f(){for(var e=w.lines[0].squares[w.lines[0].squares.length-1],r=1;r<w.lines.length;r++)w.lines[r].squares[w.lines[r].squares.length-1].coordX>e.coordX&&(e=w.lines[r].squares[w.lines[r].squares.length-1]);return e}function q(){for(var e=w.lines[0].squares[0],r=1;r<w.lines.length;r++)w.lines[r].squares[0].coordY<e.coordY&&(e=w.lines[r].squares[0]);return e}function E(){for(var e=w.lines[0].squares[w.lines[0].squares.length-1],r=1;r<w.lines.length;r++)w.lines[r].squares[w.lines[r].squares.length-1].coordY>e.coordY&&(e=w.lines[r].squares[w.lines[r].squares.length-1]);return e}function h(e){for(var r=[],o=0;o<e.lines.length;o++)for(var s=0;s<e.lines[o].squares.length;s++){var n=e.lines[o].squares[s];r[n.coordX]&&r[n.coordX][n.coordY]?e.lines[o].squares[s]=r[n.coordX][n.coordY]:r[n.coordX]?r[n.coordX][n.coordY]=e.lines[o].squares[s]:(r[n.coordX]=[],r[n.coordX][n.coordY]=e.lines[o].squares[s])}}function g(){for(var e=0;e<w.lines.length;e++)w.lines[e].clue=document.getElementById("clue-entry-"+w.lines[e].num+(w.lines[e].horizontal?"h":"d")).value}require("../lz-string");var w,L={WIDTH:1e3,HEIGHT:1e3,SQUARE_SIZE:30,BUMPER_SIZE:1,FILL_COLOUR:"#DDDDDD",LINE_COLOUR:"#999999",LINE_COLOUR_HOVER:"#000000",FILL_COLOUR_HOVER:"#FFFFFF",SELECTED_COLOUR:"#000000",LINE_WIDTH:1,LINE_WIDTH_HOVER:2,CONTAINER:"xword2",TEXT_ENTRY_FILL:"#B2E0FF"};return{getViewProperties:function(){return L},get:function(){return w={squares:o(),viewProperties:r(),addLine:n,addNumbersToSquares:d}},generateUrl:function(e){var r={};r.lines=[];for(var o=c(),s=f(),n=q(),t=E(),u=0;u<w.lines.length;u++)r.lines[u]=l(w.lines[u],o,n,e);r.stageWidth=s.offsetX+L.BUMPER_SIZE+L.SQUARE_SIZE-o.offsetX,r.stageHeight=t.offsetY+L.BUMPER_SIZE+L.SQUARE_SIZE-n.offsetY;var a=LZString.compressToBase64(JSON.stringify(r));return document.URL.split("?xword=")[0]+"?xword="+encodeURIComponent(a)},getObjectFromUrl:function(){var e=JSON.parse(LZString.decompressFromBase64(decodeURIComponent(document.URL.split("?xword=")[1])));return h(e),w=e,e},saveClues:function(){g()}}});